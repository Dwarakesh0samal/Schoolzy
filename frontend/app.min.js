// Schoolzy Frontend - Minified & Optimized
(function(){'use strict';const API_BASE='https://schoolzy-k8g7.onrender.com/api';let map,currentUser=null,schools=[],markers=[];const utils={showError:function(msg){const errorDiv=document.createElement('div');errorDiv.className='error-message';errorDiv.textContent=msg;document.body.appendChild(errorDiv);setTimeout(()=>errorDiv.remove(),5000)},showSuccess:function(msg){const successDiv=document.createElement('div');successDiv.className='success-message';successDiv.textContent=msg;document.body.appendChild(successDiv);setTimeout(()=>successDiv.remove(),3000)},debounce:function(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}},validateEmail:function(email){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)},validatePassword:function(password){return password.length>=6}};const auth={async checkStatus(){const token=localStorage.getItem('token');if(!token)return this.updateUI(false);try{const res=await fetch(`${API_BASE}/auth/me`,{headers:{'Authorization':`Bearer ${token}`}});if(res.ok){currentUser=await res.json();localStorage.setItem('user',JSON.stringify(currentUser));this.updateUI(true)}else{localStorage.removeItem('token');localStorage.removeItem('user');this.updateUI(false)}}catch(err){localStorage.removeItem('token');localStorage.removeItem('user');this.updateUI(false)}},updateUI(authenticated){const authButtons=document.getElementById('auth-buttons'),userInfo=document.getElementById('user-info'),schoolsSection=document.getElementById('schools'),mapSection=document.getElementById('map'),promptSection=document.getElementById('prompt-section');if(authenticated){authButtons.classList.add('hidden');userInfo.classList.remove('hidden');const userName=document.getElementById('user-name'),userAvatar=document.getElementById('user-avatar');userName.textContent=currentUser.name;userAvatar.src=currentUser.profile_picture||`https://via.placeholder.com/32x32/667eea/ffffff?text=${currentUser.name.charAt(0)}`;mapSection.classList.remove('hidden');schoolsSection.classList.add('hidden');promptSection.classList.add('hidden')}else{authButtons.classList.remove('hidden');userInfo.classList.add('hidden');currentUser=null;schoolsSection.classList.add('hidden');mapSection.classList.add('hidden');promptSection.classList.remove('hidden');document.getElementById('prompt-message').textContent='Please log in and enter your location to find schools near you.'}},async login(email,password){try{const res=await fetch(`${API_BASE}/auth/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});if(res.ok){const data=await res.json();localStorage.setItem('token',data.token);currentUser=data.user;this.updateUI(true);utils.showSuccess('Login successful!');hideModal('login-modal')}else{const error=await res.json();utils.showError(error.message||'Login failed')}}catch(err){utils.showError('Network error. Please try again.')}},async register(name,email,password){try{const res=await fetch(`${API_BASE}/auth/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,email,password})});if(res.ok){utils.showSuccess('Registration successful! Please log in.');hideModal('register-modal');showModal('login-modal')}else{const error=await res.json();utils.showError(error.message||'Registration failed')}}catch(err){utils.showError('Network error. Please try again.')}},logout(){localStorage.removeItem('token');localStorage.removeItem('user');currentUser=null;this.updateUI(false);utils.showSuccess('Logged out successfully')}};const schoolsAPI={async load(filters={}){const loading=document.getElementById('loading'),schoolsGrid=document.getElementById('schools-grid');loading.classList.remove('hidden');schoolsGrid.innerHTML='';try{const queryParams=new URLSearchParams(filters).toString(),response=await fetch(`${API_BASE}/schools?${queryParams}`);schools=await response.json();this.display(schools)}catch(error){utils.showError('Error loading schools. Please try again.');schoolsGrid.innerHTML='<p class="error">Error loading schools. Please try again.</p>'}finally{loading.classList.add('hidden')}},display(schoolsToDisplay){const schoolsGrid=document.getElementById('schools-grid');if(schoolsToDisplay.length===0){schoolsGrid.innerHTML='<p class="no-results">No schools found matching your criteria.</p>';return}schoolsGrid.innerHTML=schoolsToDisplay.map(school=>`<div class="school-card" onclick="window.location.href='school.html?id=${school.id}'"><div class="school-image"><i class="fas fa-school"></i></div><div class="school-content"><h3 class="school-name">${school.name}</h3><p class="school-location"><i class="fas fa-map-marker-alt"></i>${school.location}</p><div class="school-rating"><span class="stars">${'★'.repeat(Math.round(school.averageRating||0))}${'☆'.repeat(5-Math.round(school.averageRating||0))}</span><span>${(school.averageRating||0).toFixed(1)} (${school.reviewCount||0} reviews)</span></div><span class="school-category">${school.category||'School'}</span></div></div>`).join('')},async getById(id){try{const response=await fetch(`${API_BASE}/schools/${id}`);if(response.ok)return await response.json();else throw new Error('School not found')}catch(error){utils.showError('Error loading school details');return null}}};const mapAPI={init(){if(map)return;map=L.map('map-container').setView([20.2961,85.8245],10);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(map);this.loadSchools()},async loadSchools(){try{const response=await fetch(`${API_BASE}/schools`);schools=await response.json();this.addMarkers(schools)}catch(error){utils.showError('Error loading schools on map')}},addMarkers(schoolsToAdd){markers.forEach(marker=>map.removeLayer(marker));markers=[];schoolsToAdd.forEach(school=>{if(school.coordinates&&school.coordinates.lat&&school.coordinates.lng){const marker=L.marker([school.coordinates.lat,school.coordinates.lng]).addTo(map);marker.bindPopup(`<b>${school.name}</b><br>${school.location}<br>Rating: ${(school.averageRating||0).toFixed(1)} ⭐`);markers.push(marker)}})},findNearby(lat,lng,radius=10){const nearby=schools.filter(school=>{if(!school.coordinates)return false;const distance=this.calculateDistance(lat,lng,school.coordinates.lat,school.coordinates.lng);return distance<=radius});this.addMarkers(nearby);return nearby},calculateDistance(lat1,lon1,lat2,lon2){const R=6371;const dLat=this.deg2rad(lat2-lat1);const dLon=this.deg2rad(lon2-lon1);const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(this.deg2rad(lat1))*Math.cos(this.deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c},deg2rad(deg){return deg*(Math.PI/180)}};const reviewsAPI={async getBySchool(schoolId){try{const response=await fetch(`${API_BASE}/reviews/school/${schoolId}`);if(response.ok)return await response.json();return{reviews:[],pagination:{totalReviews:0}}}catch(error){utils.showError('Error loading reviews');return{reviews:[],pagination:{totalReviews:0}}}},async add(schoolId,rating,reviewText){if(!currentUser){utils.showError('Please log in to add a review');return}try{const response=await fetch(`${API_BASE}/reviews/school/${schoolId}`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${localStorage.getItem('token')}`},body:JSON.stringify({rating,review_text:reviewText})});if(response.ok){utils.showSuccess('Review added successfully!');return true}else{const error=await response.json();utils.showError(error.message||'Error adding review');return false}}catch(error){utils.showError('Network error. Please try again.');return false}}};function showModal(modalId){document.getElementById(modalId).classList.remove('hidden')}function hideModal(modalId){document.getElementById(modalId).classList.add('hidden')}function hideAllModals(){document.querySelectorAll('.modal').forEach(modal=>modal.classList.add('hidden'))}function scrollToSection(sectionId){document.getElementById(sectionId).scrollIntoView({behavior:'smooth'})}const eventHandlers={setup(){this.setupAuth();this.setupSearch();this.setupMap();this.setupModals();this.setupNavigation()},setupAuth(){document.getElementById('login-btn').addEventListener('click',()=>showModal('login-modal'));document.getElementById('register-btn').addEventListener('click',()=>showModal('register-modal'));document.getElementById('login-form').addEventListener('submit',async(e)=>{e.preventDefault();const email=document.getElementById('login-email').value,password=document.getElementById('login-password').value;if(!utils.validateEmail(email)){utils.showError('Please enter a valid email');return}await auth.login(email,password)});document.getElementById('register-form').addEventListener('submit',async(e)=>{e.preventDefault();const name=document.getElementById('register-name').value,email=document.getElementById('register-email').value,password=document.getElementById('register-password').value;if(!utils.validatePassword(password)){utils.showError('Password must be at least 6 characters');return}await auth.register(name,email,password)});document.getElementById('logout-btn').addEventListener('click',()=>auth.logout())},setupSearch(){const searchBtn=document.getElementById('search-btn'),schoolSearch=document.getElementById('school-search'),categoryFilter=document.getElementById('category-filter'),ratingFilter=document.getElementById('rating-filter');const performSearch=utils.debounce(()=>{const filters={};if(schoolSearch.value)filters.search=schoolSearch.value;if(categoryFilter.value)filters.category=categoryFilter.value;if(ratingFilter.value)filters.rating=ratingFilter.value;schoolsAPI.load(filters)},300);searchBtn.addEventListener('click',performSearch);schoolSearch.addEventListener('input',performSearch);categoryFilter.addEventListener('change',performSearch);ratingFilter.addEventListener('change',performSearch)},setupMap(){const locateBtn=document.getElementById('locate-btn'),citySearchBtn=document.getElementById('city-search-btn'),radiusInput=document.getElementById('radius-input');locateBtn.addEventListener('click',()=>{if(navigator.geolocation){navigator.geolocation.getCurrentPosition(async(position)=>{const{latitude:lat,longitude:lng}=position.coords;map.setView([lat,lng],12);const radius=parseInt(radiusInput.value)||10;const nearby=mapAPI.findNearby(lat,lng,radius);utils.showSuccess(`Found ${nearby.length} schools within ${radius}km`);},(error)=>{utils.showError('Unable to get your location. Please try again.')})}else{utils.showError('Geolocation is not supported by your browser')}});citySearchBtn.addEventListener('click',async()=>{const cityInput=document.getElementById('city-search');if(cityInput.value.trim()){try{const response=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cityInput.value)}`);const data=await response.json();if(data.length>0){const{lat,lng}=data[0];map.setView([parseFloat(lat),parseFloat(lng)],12);const radius=parseInt(radiusInput.value)||10;const nearby=mapAPI.findNearby(parseFloat(lat),parseFloat(lng),radius);utils.showSuccess(`Found ${nearby.length} schools in ${cityInput.value}`)}else{utils.showError('Location not found')}}catch(error){utils.showError('Error searching location')}}})},setupModals(){document.querySelectorAll('.close').forEach(closeBtn=>{closeBtn.addEventListener('click',()=>hideAllModals())});document.addEventListener('click',(e)=>{if(e.target.classList.contains('modal'))hideAllModals()})},setupNavigation(){document.querySelectorAll('.nav-link').forEach(link=>{link.addEventListener('click',(e)=>{e.preventDefault();const targetId=link.getAttribute('href').substring(1);scrollToSection(targetId)})})}};async function initializeApp(){await auth.checkStatus();schoolsAPI.load();mapAPI.init();eventHandlers.setup()}document.addEventListener('DOMContentLoaded',initializeApp);window.schoolzy={auth,schoolsAPI,mapAPI,reviewsAPI,utils,showModal,hideModal,scrollToSection}})(); 